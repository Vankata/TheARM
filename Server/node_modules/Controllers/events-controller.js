
var serverContext = require("./../../models/server-context");


module.exports = 
{
    createEvent : function (newEvent, companyName) {
		var result = "OK";
		console.log('eventId ' + newEvent.eventId);
		console.log('description ' + newEvent.description);
		console.log('minUsers ' + newEvent.minUsers);
		console.log('maxUsers ' + newEvent.maxUsers);
		console.log('startTime ' + newEvent.startTime);
		console.log('endTime ' + newEvent.endTime);
		
		console.log(JSON.stringify(newEvent));
		serverContext().then(function(models){
			models.company.find({name: companyName}, 1, function(error, foundedCompanies) {
				var company = null;
				if (foundedCompanies) {
					company = foundedCompanies[0];
				}
				console.log("COMPANY: " + JSON.stringify(company));
				if (company) {
					company.getUsers(function(error, users) {
						console.log("USERS: " + users);
						console.log("EVENT: " + newEvent);
						models.event.create([newEvent], function(error, insertedEvent) {
							console.log("INSERTED " + insertedEvent);
							for (var index in users) {
								var user = users[index];
								user.addEvents([insertedEvent], function(err, items) {});
							}
						});
					});
				}
			});
		}, function(error) {
			result = "Server error - " + error;
		});
		return result;
    }
};