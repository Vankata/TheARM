var datacontext = require('../../models/server-context.js');
var apn = require('apn');
var Q = require("q");

var companiesController = require('./companies-controller.js');

module.exports = 
{
    sendPushNotifications : function(){
		console.log("Making notification check");
        companiesController.getEventsByCompany(1).then(function(result){
            var options = { production: false };
	        var apnConnection = new apn.Connection(options);
            for(i = 0; i < result.length; i++){
                if(areLessThanApart(result[i].startTime, new Date(), 5)){
                    //<= 5 minutes remaining- send push notification
                   for(j = 0; j < result[i].users.length; j++){
                       var userDevice = new apn.Device(result[i].users[j].token.trim());
                       var note = new apn.Notification();
					   
					   console.log(result[i].users[j].token.trim());
					   
                       note.expiry = Math.floor(Date.now() / 1000) + 3600; // Expires 1 hour from now.
                       note.badge = 3;
                       note.sound = "ping.aiff";
					   
					   var message = result[i].description + ": You have event in 5 minutes.";
					   
                       note.alert = message;
                       
                       apnConnection.pushNotification(note, userDevice);
					   
					   var options = {
						"batchFeedback": true,
						"interval": 3
					   };

					var feedback = new apn.Feedback(options);
					feedback.on("feedback", function(devices) {
						devices.forEach(function(item) {
							console.log(item);
						});
					});
                   }
                }
            }
        }, function(error){
            
        });
    }
}

function areLessThanApart (date1, date2, timeInterval){
    var diffMs = (date1 - date2);
    return diffMs <= timeInterval * 60 * 1000;
}