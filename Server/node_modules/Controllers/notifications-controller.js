var datacontext = require('../../models/server-context.js');
var apn = require('apn');
var Q = require("q");

var companiesController = require('./companies-controller.js');

module.exports = 
{
    sendPushNotifications : function(){
        companiesController.getEventsByCompany(1).then(function(result){
            var options = { };
	        var apnConnection = new apn.Connection(options);
            for(i = 0; i < result.length; i++){
                if(areLessThanApart(result[i].startTime, new Date(), 5)){
                    //<= 5 minutes remaining- send push notification
                   for(j = 0; j < result[i].users.length; j++){
                       var userDevice = new apn.Device(result[i].users[j].token);
                       
                       var note = new apn.Notification();

                       note.expiry = Math.floor(Date.now() / 1000) + 3600; // Expires 1 hour from now.
                       note.badge = 3;
                       note.sound = "ping.aiff";
                       note.alert = "You have event in 5 minutes.";
                       
                       apnConnection.pushNotification(note, userDevice);
                   }
                }
            }
        }, function(error){
            
        });
    }
}

function areLessThanApart (date1, date2, timeInterval){
    var diffMs = (date1 - date2);
    return diffMs <= timeInterval * 60 * 1000;
}